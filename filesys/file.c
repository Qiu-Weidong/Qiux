#include "file.h"
#include "const.h"
#define FILE_NR 128

// 私有变量
private file_t file_list[FILE_NR];
private list file_slots;

/*===========================================================================*
 *				file_init				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 初始化file_list
 * 执行进程 TASK_FS
 *****************************************************************************/
public void file_init()
{
    list_init(&file_slots);
    for(int i=0;i<FILE_NR;i++)
    {
        file_list[i].inode = 0;
        list_push_back(&file_slots, &file_list[i].slot_elem);
    }
}

/*===========================================================================*
 *				file_open				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 打开文件
 * 执行进程 TASK_FS
 * 成功则返回打开的文件指针，否则返回nullptr
 *****************************************************************************/
public file_t * file_open(inode_t * inode, uint32_t mode)
{
    static uint32_t next_fd = 2;

    if(list_empty(&file_slots)) return nullptr;
    file_t * file = list_entry(list_pop_front(&file_slots), file_t, slot_elem);
    file->fd = next_fd++;
    file->pos = 0;
    file->mode = mode;
    file->inode = inode;

    return file;
}

/*===========================================================================*
 *				file_close				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 关闭文件
 * 执行进程 TASK_FS
 *****************************************************************************/
public void file_close(file_t * file)
{
    inode_close(file->inode);
    list_push_back(&file_slots, &file->slot_elem);
}

/*===========================================================================*
 *				file_read				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 读文件
 * 执行进程 TASK_FS
 *****************************************************************************/
public size_t file_read(file_t * file, void * buffer, size_t size)
{
    size_t result = inode_read(file->inode, buffer, size, file->pos);
    file->pos += result;
    return result;
}

/*===========================================================================*
 *				file_write				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 写文件
 * 执行进程 TASK_FS
 *****************************************************************************/
public size_t file_write(file_t *file, void *buffer, size_t size)
{
    size_t result = inode_write(file->inode, buffer, size, file->pos);
    file->pos += result;
    return result;
}

/*===========================================================================*
 *				file_size				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 获取文件大小
 * 执行进程 TASK_FS
 *****************************************************************************/
public size_t file_size(file_t * file)
{
    return file->inode->size;
}

/*===========================================================================*
 *				file_seek				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 移动pos
 * 执行进程 TASK_FS
 *****************************************************************************/
public void file_seek(file_t *file, offset_t off, int mode)
{
    if(mode == FSEEK_SET)
    {
        file->pos = off;
    }
    else if(mode == FSEEK_CUR)
    {
        file->pos += off;
    }
    else if(mode == FSEEK_END)
    {
        file->pos = file->inode->size + off;
    }
    file->pos = file->inode->size > file->pos ? file->pos : file->inode->size ;
}

/*===========================================================================*
 *				file_tell				     *
 *===========================================================================*/
/*****************************************************************************
 * <特权级 1> 返回文件pos
 * 执行进程 TASK_FS
 *****************************************************************************/
public offset_t file_tell(file_t *file)
{
    return file->pos;
}

